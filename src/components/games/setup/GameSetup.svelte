<script type="ts">
  import { launcherConfig } from "$lib/config";
  import {
    gameNeedsReinstall,
    isInstalling,
    ProcessLogs,
  } from "$lib/stores/AppStore";
  import {
    checkRequirements,
    fullInstallation,
    recompileGame,
  } from "$lib/setup/setup";
  // components
  import Progress from "./Progress.svelte";
  // constants
  import type { SupportedGame } from "$lib/constants";
  import LogViewer from "./LogViewer.svelte";
  import Requirements from "./Requirements.svelte";
  import { createEventDispatcher, onMount } from "svelte";
  import { Button } from "flowbite-svelte";

  export let activeGame: SupportedGame;

  const dispatch = createEventDispatcher();

  let componentLoaded = false;
  let requirementsMet = false;

  onMount(async () => {
    // NOTE - potentially has problems if the user changes hardware
    if (!(await launcherConfig.areRequirementsMet())) {
      await checkRequirements();
    }
    requirementsMet = await launcherConfig.areRequirementsMet();
    componentLoaded = true;
  });

  async function fullInstall() {
    const success = await fullInstallation(activeGame);
    if (success) {
      dispatch("change");
    }
  }

  async function updateGame() {
    const success = await recompileGame(activeGame);
    if (success) {
      dispatch("change");
    }
  }
</script>

{#if componentLoaded}
  <div class="content">
    <div style="text-align:center">
      {#if !requirementsMet}
        <Requirements />
      {:else}
        {#if !$isInstalling}
          {#if $gameNeedsReinstall}
            <Button
              class="!rounded-none !bg-[#222222] text-xl"
              on:click={updateGame}>Update Install</Button
            >
          {:else}
            <Button
              class="!rounded-none !w-56 !bg-[#222222] text-xl"
              on:click={fullInstall}>Install</Button
            >
          {/if}
        {:else}
          <Progress />
        {/if}
        {#if $ProcessLogs}
          <LogViewer />
        {/if}
      {/if}
    </div>
  </div>
{:else}
  <!-- TODO - component library - spinner -->
{/if}
